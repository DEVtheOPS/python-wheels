name: Build Wheels

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Specific package to build (optional, builds all if empty)"
        required: false
        type: string
      python_versions:
        description: "Python versions (comma-separated)"
        required: false
        default: "3.12,3.13"
        type: string
      cuda_versions:
        description: "CUDA versions (comma-separated)"
        required: false
        default: "12.9.1,13.0.2"
        type: string

  push:
    paths:
      - "config/packages.yml"
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  prepare:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Generate build matrix
        id: set-matrix
        run: |
          python3 << 'EOF'
          import json
          import os
          import yaml

          with open('config/packages.yml', 'r', encoding='utf-8') as f:
              config = yaml.safe_load(f) or {}

          packages = config.get('packages', {})

          package_filter = '${{ inputs.package }}'
          if package_filter:
              packages = {k: v for k, v in packages.items() if k == package_filter}

          python_input = '${{ inputs.python_versions }}'
          cuda_input = '${{ inputs.cuda_versions }}'
          python_versions = python_input.split(',') if python_input else ['3.12', '3.13']
          cuda_versions = cuda_input.split(',') if cuda_input else ['12.9.1', '13.0.2']

          def cleaned(items):
              return [item.strip() for item in items if item.strip()]

          python_versions = cleaned(python_versions)
          cuda_versions = cleaned(cuda_versions)

          matrix_entries = []
          for pkg_name, pkg_config in packages.items():
              for version in pkg_config.get('versions', []):
                  for python in python_versions:
                      for cuda in cuda_versions:
                          matrix_entries.append({
                              'package': pkg_name,
                              'version': str(version).strip(),
                              'python': python,
                              'cuda': cuda,
                              'build_args': pkg_config.get('build_args', ''),
                              'extra_deps': ' '.join(pkg_config.get('extra_deps', [])),
                              'test_import': pkg_config.get('test_import', pkg_name.replace('-', '_')),
                          })

          matrix = {'include': matrix_entries}

          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as f:
              f.write(f"matrix={json.dumps(matrix)}\n")

          print(f"Generated matrix with {len(matrix_entries)} jobs")
          print(json.dumps(matrix, indent=2))
          EOF

  build:
    name: Build ${{ matrix.package }} (py${{ matrix.python }}, CUDA ${{ matrix.cuda }})
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.matrix != '{"include":[]}'

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h

          # Remove unnecessary tools and packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

          # Clean apt cache
          sudo apt-get clean

          # Remove unused Docker images
          docker system prune -af

          echo ""
          echo "Disk space after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull CUDA Docker image
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: docker pull nvidia/cuda:${{ matrix.cuda }}-devel-ubuntu22.04

      - name: Build wheel
        id: build
        run: |
          set -euo pipefail

          PACKAGE="${{ matrix.package }}"
          VERSION="${{ matrix.version }}"
          PYTHON="${{ matrix.python }}"
          CUDA="${{ matrix.cuda }}"
          BUILD_ARGS="${{ matrix.build_args }}"
          EXTRA_DEPS="${{ matrix.extra_deps }}"

          echo "Building $PACKAGE==$VERSION for Python $PYTHON with CUDA $CUDA"

          OUTPUT_DIR="$(pwd)/wheels"
          mkdir -p "$OUTPUT_DIR"

          # Build wheel in Docker using build script
          docker run --rm \
            -v "$OUTPUT_DIR:/workspace/wheels" \
            -v "$(pwd)/scripts:/workspace/scripts:ro" \
            -e PACKAGE="$PACKAGE" \
            -e VERSION="$VERSION" \
            -e PYTHON_VERSION="$PYTHON" \
            -e CUDA_VERSION="$CUDA" \
            -e BUILD_ARGS="$BUILD_ARGS" \
            -e EXTRA_DEPS="$EXTRA_DEPS" \
            nvidia/cuda:${CUDA}-devel-ubuntu22.04 \
            bash /workspace/scripts/build_in_docker.sh

          # Find the built wheel
          WHEEL_FILE=$(ls wheels/*.whl | head -1)
          if [ -z "$WHEEL_FILE" ]; then
              echo "Error: No wheel file found"
              exit 1
          fi

          echo "wheel_file=$WHEEL_FILE" >> $GITHUB_OUTPUT
          echo "wheel_name=$(basename $WHEEL_FILE)" >> $GITHUB_OUTPUT

      - name: Test wheel import
        run: |
          WHEEL_FILE="${{ steps.build.outputs.wheel_file }}"
          TEST_IMPORT="${{ matrix.test_import }}"
          CUDA="${{ matrix.cuda }}"
          PYTHON="${{ matrix.python }}"

          echo "Testing import of $TEST_IMPORT"

          docker run --rm \
            -v "$(pwd)/wheels:/wheels" \
            nvidia/cuda:${CUDA}-runtime-ubuntu22.04 \
            bash -c "
          set -euo pipefail

          export DEBIAN_FRONTEND=noninteractive
          apt-get update -qq
          apt-get install -y -qq software-properties-common
          add-apt-repository -y ppa:deadsnakes/ppa
          apt-get update -qq
          apt-get install -y -qq python${PYTHON} python${PYTHON}-venv

          python${PYTHON} -m venv /venv
          source /venv/bin/activate
          pip install --quiet --upgrade pip

          # Install runtime dependencies based on CUDA version
          CUDA_MAJOR=\$(echo ${CUDA} | cut -d'.' -f1)
          CUDA_MINOR=\$(echo ${CUDA} | cut -d'.' -f2)

          echo '==> Installing runtime dependencies'
          if [ \"\$CUDA_MAJOR\" = \"13\" ]; then
              echo 'Using PyTorch nightly with CUDA 13.0 support'
              # Use PyTorch nightly with CUDA 13.0 support
              pip install --quiet torch --index-url https://download.pytorch.org/whl/cu130

              echo 'Installed PyTorch version:'
              pip show torch | grep Version
          elif [ \"\$CUDA_MAJOR\" = \"12\" ]; then
              # For CUDA 12.x, use stable PyTorch
              pip install --quiet torch --index-url https://download.pytorch.org/whl/cu\${CUDA_MAJOR}\${CUDA_MINOR}
              echo 'Installed PyTorch version:'
              pip show torch | grep Version
          else
              pip install --quiet torch
          fi

          # Install numpy
          pip install --quiet numpy

          # Install the wheel (with dependencies)
          echo '==> Installing wheel'
          pip install --quiet /wheels/*.whl

          echo '==> Verifying installations'
          python -c 'import torch; print(f\"PyTorch: {torch.__version__}, CUDA: {torch.version.cuda}\")'
          python -c 'import numpy; print(f\"NumPy: {numpy.__version__}\")'

          echo '==> Testing flash-attn import'
          python -c 'import ${TEST_IMPORT}; print(\"âœ“ Import successful\")'
          "

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.package }}-${{ matrix.version }}-py${{ matrix.python }}-cuda${{ matrix.cuda }}
          path: wheels/*.whl
          if-no-files-found: error
          retention-days: 90

      - name: Clean up Docker images
        if: always()
        run: |
          echo "Cleaning up Docker images to free space..."
          docker system prune -af
          df -h

  release:
    name: Create Release and Update Index
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels-artifacts
          pattern: wheel-*
          merge-multiple: true

      - name: Organize wheels
        run: |
          mkdir -p wheels
          find wheels-artifacts -name '*.whl' -exec mv {} wheels/ \;
          ls -lh wheels/

      - name: Generate release tag
        id: tag
        run: |
          TAG="v$(date +%Y-%m-%d)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Wheels ${{ steps.tag.outputs.tag }}
          body: |
            ## Built Wheels

            Wheels built on $(date +%Y-%m-%d) for:
            - Python versions: 3.12, 3.13
            - CUDA versions: 12.1.0, 13.0

            ### Installation

            ```bash
            pip install <package> --extra-index-url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/simple/
            ```

            ### Available Packages

            See attached wheel files below.
          files: wheels/*.whl
          draft: false
          prerelease: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate PyPI index
        run: |
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}"
          python3 scripts/generate_index.py \
            --wheels-dir wheels \
            --output-dir index/simple \
            --base-url "$BASE_URL"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./index
          publish_branch: gh-pages
          force_orphan: true
